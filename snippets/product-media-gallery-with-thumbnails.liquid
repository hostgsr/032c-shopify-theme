{% comment %}
  Renders a product media gallery with thumbnails. Should be used with 'media-gallery-with-thumbnails.js'

  Features:
  - Desktop: Shows 2 images in grid layout with thumbnails below (2 images per thumbnail group)
  - Mobile: Shows 1 image with all thumbnails below
  - Click thumbnails to navigate between image pairs

  Accepts:
  - product: {Object} Product liquid object
  - variant_images: {Array} Product images associated with a variant
  - limit: {Number} (optional) When passed, limits the number of media items to render

  Usage:
  {% render 'product-media-gallery-with-thumbnails' %}
{% endcomment %}

{%- liquid
  if section.settings.hide_variants and variant_images.size == product.media.size
    assign single_media_visible = true
  endif

  if limit == 1
    assign single_media_visible = true
  endif

  assign media_count = product.media.size
  if section.settings.hide_variants and media_count > 1 and variant_images.size > 0
    assign media_count = media_count | minus: variant_images.size | plus: 1
  endif

  if media_count == 1 or single_media_visible
    assign single_media_visible_mobile = true
  endif

  if section.settings.media_size == 'large'
    assign media_width = 0.65
  elsif section.settings.media_size == 'medium'
    assign media_width = 0.50
  elsif section.settings.media_size == 'small'
    assign media_width = 0.45
  endif

  # Calculate how many thumbnail groups we need (2 images per group)
  assign thumbnail_groups = media_count | divided_by: 2.0 | ceil
-%}

<media-gallery-with-thumbnails
  id="MediaGalleryThumbnails-{{ section.id }}"
  role="region"
  {% if section.settings.enable_sticky_info %}
    class="product__column-sticky"
  {% endif %}
  aria-label="{{ 'products.product.media.gallery_viewer' | t }}"
  data-media-count="{{ media_count }}"
>
  {{ 'media-gallery-with-thumbnails.css' | asset_url | stylesheet_tag }}
  <script src="{{ 'media-gallery-with-thumbnails.js' | asset_url }}" defer="defer"></script>

  <div id="GalleryStatus-{{ section.id }}" class="visually-hidden" role="status"></div>

  <!-- Desktop Layout: Thumbnails on left, Images on right -->
  <div class="media-gallery-thumbnails__main" id="MainGallery-{{ section.id }}">
    <!-- Thumbnails Navigation (Left Column) -->
    {%- if media_count > 2 -%}
      <div class="media-gallery-thumbnails__nav" id="ThumbnailNav-{{ section.id }}">
        <div class="media-gallery-thumbnails__nav-inner">
          {%- assign media_position = 0 -%}
          {%- assign group_index = 0 -%}

          {%- for media in product.media -%}
            {%- if media_position >= limit -%}
              {%- break -%}
            {%- endif -%}

            {%- unless section.settings.hide_variants and variant_images contains media.src -%}
              {%- assign media_position = media_position | plus: 1 -%}

              {%- comment -%} Create thumbnail groups of 2 images each {%- endcomment -%}
              {%- assign is_first_in_group = media_position | modulo: 2 -%}
              {%- if is_first_in_group == 1 -%}
                {%- assign group_index = group_index | plus: 1 -%}
                <button
                  type="button"
                  class="media-gallery-thumbnails__nav-item{% if group_index == 1 %} is-active{% endif %}"
                  data-group="{{ group_index }}"
                  data-start-position="{{ media_position }}"
                  aria-label="View images {{ media_position }}-{{ media_position | plus: 1 | at_most: media_count }}"
                >
                  <div class="media-gallery-thumbnails__nav-preview">
                    {%- comment -%} Show preview of first image in the group {%- endcomment -%}
                    {{
                      media.preview_image
                      | image_url: width: 120
                      | image_tag: loading: 'lazy', sizes: '60px', widths: '60, 120', alt: media.alt
                    }}

                    {%- comment -%} Show preview of second image if it exists {%- endcomment -%}
                    {%- assign next_media_index = forloop.index -%}
                    {%- for next_media in product.media offset: next_media_index limit: 1 -%}
                      {%- unless section.settings.hide_variants and variant_images contains next_media.src -%}
                        <div class="media-gallery-thumbnails__nav-preview-second">
                          {{
                            next_media.preview_image
                            | image_url: width: 120
                            | image_tag: loading: 'lazy', sizes: '60px', widths: '60, 120', alt: next_media.alt
                          }}
                        </div>
                      {%- endunless -%}
                    {%- endfor -%}
                  </div>
                  <span class="media-gallery-thumbnails__nav-label">
                    {{ media_position }}-{{ media_position | plus: 1 | at_most: media_count }}
                  </span>
                </button>
              {%- endif -%}
            {%- endunless -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    <!-- Main Images Grid (Right Column) -->
    <div class="media-gallery-thumbnails__grid">
      {%- assign media_position = 0 -%}
      {%- for media in product.media -%}
        {%- if media_position >= limit -%}
          {%- break -%}
        {%- endif -%}

        {%- unless section.settings.hide_variants and variant_images contains media.src -%}
          {%- assign media_position = media_position | plus: 1 -%}
          <div
            class="media-gallery-thumbnails__item{% if media_position <= 2 %} is-active{% endif %}"
            data-media-id="{{ section.id }}-{{ media.id }}"
            data-media-position="{{ media_position }}"
          >
            {%
              render 'product-thumbnail',
              media: media,
              media_count: media_count,
              position: media_position,
              desktop_layout: 'columns',
              mobile_layout: 'columns',
              loop: section.settings.enable_video_looping,
              modal_id: section.id,
              xr_button: true,
              media_width: media_width,
              media_fit: section.settings.media_fit,
              constrain_to_viewport: section.settings.constrain_to_viewport,
              lazy_load: media_position > 2
            %}
          </div>
        {%- endunless -%}
      {%- endfor -%}
    </div>
  </div>

  {%- comment -%} Mobile single image slider {%- endcomment -%}
  <div class="media-gallery-thumbnails__mobile small-up-hide">
    <div class="media-gallery-thumbnails__mobile-main">
      <div class="media-gallery-thumbnails__mobile-current" id="MobileGallery-{{ section.id }}">
        {%- assign media_position = 0 -%}
        {%- for media in product.media -%}
          {%- if media_position >= limit -%}
            {%- break -%}
          {%- endif -%}

          {%- unless section.settings.hide_variants and variant_images contains media.src -%}
            {%- assign media_position = media_position | plus: 1 -%}
            <div
              class="media-gallery-thumbnails__mobile-item{% if media_position == 1 %} is-active{% endif %}"
              data-mobile-media-id="{{ section.id }}-{{ media.id }}"
              data-mobile-position="{{ media_position }}"
            >
              {%
                render 'product-thumbnail',
                media: media,
                media_count: media_count,
                position: media_position,
                desktop_layout: 'columns',
                mobile_layout: 'columns',
                loop: section.settings.enable_video_looping,
                modal_id: section.id,
                xr_button: true,
                media_width: 1,
                media_fit: section.settings.media_fit,
                constrain_to_viewport: section.settings.constrain_to_viewport,
                lazy_load: media_position > 1
              %}
            </div>
          {%- endunless -%}
        {%- endfor -%}
      </div>
    </div>

    {%- if media_count > 1 -%}
      <div class="media-gallery-thumbnails__mobile-nav">
        <div class="media-gallery-thumbnails__mobile-nav-inner">
          {%- assign media_position = 0 -%}
          {%- for media in product.media -%}
            {%- if media_position >= limit -%}
              {%- break -%}
            {%- endif -%}

            {%- unless section.settings.hide_variants and variant_images contains media.src -%}
              {%- assign media_position = media_position | plus: 1 -%}
              <button
                type="button"
                class="media-gallery-thumbnails__mobile-nav-item{% if media_position == 1 %} is-active{% endif %}"
                data-mobile-target="{{ media_position }}"
                aria-label="View image {{ media_position }}"
              >
                {{
                  media.preview_image
                  | image_url: width: 80
                  | image_tag: loading: 'lazy', sizes: '40px', widths: '40, 80', alt: media.alt
                }}
              </button>
            {%- endunless -%}
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}
  </div>

  {%- if first_3d_model -%}
    <button
      class="button button--full-width product__xr-button"
      type="button"
      aria-label="{{ 'products.product.xr_button_label' | t }}"
      data-shopify-xr
      data-shopify-model3d-id="{{ first_3d_model.id }}"
      data-shopify-title="{{ product.title | escape }}"
      data-shopify-xr-hidden
    >
      <span class="svg-wrapper">
        {{- 'icon-3d-model.svg' | inline_asset_content -}}
      </span>
      {{ 'products.product.xr_button' | t }}
    </button>
  {%- endif -%}
</media-gallery-with-thumbnails>
